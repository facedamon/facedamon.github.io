
# 摘要

&emsp;&emsp;SaaS区别于其他应用程序的主要特征就是能够使客户在使用应用程序时按照使用量付费。他们不需要为软件购买许可，也不需要安装、托管和管理它。这方面的操作全部由提供SaaS软件的组织负责。

## 多租户是实现SaaS的关键

&emsp;&emsp;**SaaS归根结底都是与经济方面直接关联**。目前为止，我们的应用程序为不同用户完全服务，我们已经习惯这种概念，但是与SaaS环境仍然有些细微的差别。

&emsp;&emsp;在一个传统的SaaS环境中，**用户**是指某个特定组织的员工组成的多个组，这个组织就是所谓的租户。如果组织购买了这个应用程序，相当于您在一个普通的web应用程序中看到的一样。组织的员工就是应用程序的用户，而该组织就是**所有者**。

&emsp;&emsp;在现代SaaS模型中，组织就是租户，而非所有者，但是组织的员工仍然是用户的身份。每名用户都具有关联到一个特定租户。而SaaS为每个租户分别提供一份应用程序的副本，以供他们的用户使用。

## 将web应用转换为SaaS应用

&emsp;&emsp;要将您的web应用程序转换为SaaS应用程序，需要满足以下7个条件：

1. **应用程序必须支持多租户**
2. **应用程序必须具备某种成都的自主注册功能**
3. **必须具备订阅/记账机制**
4. **应用程序必须能够有效地扩展**
5. **必须能够监视、配置和管理应用程序和租户**
6. **必须有一种机制能够支持惟一的用户标识和身份验证**
7. **必须有一种机制能够支持对每个租户进行某种程度的私人定制**

&emsp;&emsp;接下来，让我们逐个地详细了解这7个条件。

### 支持多租户

&emsp;&emsp;多租户是决定SaaS效率地关键因素。通常，应用程序支持多个用户，但是前提是它认为所有用户都来自同一个组织。这种模型适用于传统的web时代，组织会购买一个软件应用程序供自己的成员使用。但是在SaaS和云的世界中，许多组织都将使用同一个应用程序；他们必须能够允许自己的用户访问应用程序，但是应用程序必须只允许每个组织自己的成员访问其组织的数据。

&emsp;&emsp;**能够让多个组织(SaaS中的术语为租户)共存于相同的应用程序，同时不会破坏这些组织的数据的安全性，具备这种能力的应用程序就可以称之为多租户应用程序。**

&emsp;&emsp;多租户可以分为以下几个不同的类别：

1. 云中的虚拟化，只对硬件共享。

![avatar](https://cdn.jsdelivr.net/gh/facedamon/markdownps2@master/micro-service/1601000693.jpg)

&emsp;&emsp;可以看出，该模型完全算不上真正的多租户，但是在云环境中，它经常与虚拟化服务器配合使用，并被认为是一种多租户行式。在实际应用中，这种模型无法满足需求。

2. 共享应用程序，对每个租户使用不同的数据库。

![avatar](https://cdn.jsdelivr.net/gh/facedamon/markdownps2@master/micro-service/1601000987.jpg)

&emsp;&emsp;这种方案的用户数据隔离级别最高，安全性最好，但成本较高。

- 优点：为不同的租户提供独立的数据库，有助于简化数据模型的扩展设计，满足不同租户的独特需求；如果出现故障，恢复数据比较简单。

- 缺点：增加了数据库的安装数量，随之带来维护成本和购置成本。

3. 共享数据库，独立Schema

![avatar](https://cdn.jsdelivr.net/gh/facedamon/markdownps2@master/micro-service/1601001210.jpg)

&emsp;&emsp;多个租户共享Database，但是每个租户一个Schema。

- 优点：为了安全性要求较高的租户提供了一定成都的逻辑数据隔离，并不是完全隔离；每个数据库可支持更多的租户数量。

- 缺点：如果出现故障，数据恢复比较困难，因为恢复数据库将牵扯到其他租户的数据；如果需要跨租户统计统计数据，存在一定困难。

4. 共享数据库，共享Schema，共享数据表

![avatar](https://cdn.jsdelivr.net/gh/facedamon/markdownps2@master/micro-service/1601016851.jpg)

&emsp;&emsp;多个租户共享同一个Database、同一个Schema，但在表中增加TenantID多租户的数据字段。这是共享程度最高、隔离级别最低的模式。没跳入一条数据时都需要有一个客户的标识，这样才能在同一张表中区分出不同的数据。

- 优点：维护和购置成本最低，允许每个数据库支持的租户数量最多。
- 缺点：隔离级别最低，安全性最低，需要在设计开始时加大最安全的开发量；数据备份和恢复最困难，需要逐表逐条备份和还原。

&emsp;&emsp;除了应用程序中出现的数据访问实例外，还存在其它一些应用程序，比如报表和工具应用程序，必须修改这些应用程序来包含必须的租户过滤功能，从而确保各个租户的数据只能由这些特定的租户访问。如果访问类型并不是直接来源于应用程序本身，那么就会产生问题，必须对这类问题进行控制。如果任何已经授权的用户可以使用报表工具，那么必须阻止阻止他们访问不属于其所属租户的数据。

> 如何选择

- 成本：隔离性越好，设计和实现的难度和成本越高，初始成本越高。共享性越好，同一运营成本下支持的用户越多，运营成本越低。

- 安全：要考虑业务和客户的安全方面的要求。安全性要求越高，越要倾向于隔离。

- 租户数量：系统需要支持多少租户？上百？上千？还是上万？租户越多，越倾向于共享。平均每个租户要存储数据需要的空间大小。存储的数据越多，越倾向于隔离。

- 定制化：针对每一个租户提供附加的服务，例如数据的备份和恢复等。这方面的需求越多，越倾向于隔离。

- 技术储备：共享性越高，对技术的要求越高。

### 自助注册

&emsp;&emsp;应用程序必须具备某种成都的自助注册功能，即便仅仅是一种请求机制，即产生一种向应用程序添加租户的业务流程。

### 订阅和记账

&emsp;&emsp;必须提供订阅和记账。因为SaaS应用程序被设计为根据各种元素进行支付，如每个租户的用户数、高级功能选择，必须通过某种方式来跟踪和管理应用程序的使用，然后生成可由租户管理人员访问的记账信息。

### 扩展和管理应用程序

&emsp;&emsp;必须能够随着订阅的增长进行扩展。云基础架构是实现这一目的的逻辑方式，因为它嵌入了许多功能，可以支持实现有效的、高效扩展。

&emsp;&emsp;同样，必须提供治理和应用程序管理功能，以监视、配置和管理应用程序及所有租户。

### 用户ID和身份验证

&emsp;&emsp;需要提供一种机制以支持用户标识和身份验证，允许用户拥有惟一的身份标识。由于多租户要求识别注册到系统中的所有用户，从而确当他们所属的租户，因此必须有一种明确的关系来将用户识别为属于某个特定租户。这种用户与租户的关系是非常重要的信息，用户限制用户可以访问的数据。

### 对每个租户进行私人定制

&emsp;&emsp;必须提供一种机制来支持对每个租户进行一定程度的基本自定义，从而使他们具有惟一的URL、登入页面、标识、配色方案、字体、甚至包括语言。

&emsp;&emsp;对每个租户的基本配置是预期的功能，但是要真正地满足多租户的需求，必须在基本配置的基础上对每个租户实现一定成都的自定义。

&emsp;&emsp;所需的典型定制类似于租户对内部应用程序版本所作出的定制。包括添加字段甚至是表格，设置特殊的业务逻辑，或集成另一种应用程序。在每个租户的基础上能够进行这类定制，同时无需建立单独的服务。这就是高性能SaaS架构的典型特征。

## 需要考虑的性能问题

&emsp;&emsp;多租户SaaS应用程序的性能问题通常与容纳同样数量的用户、具备相同的活动成都的web应用程序所遇到的问题相同。

### 数据库集群化

&emsp;&emsp;对于SaaS应用程序，用户总数可能会非常高。许多数据库技术都能够提供一种集群化的数据库模型，允许对同一个数据库提供更多的容量。

### 地理、分区和同步

&emsp;&emsp;由于SaaS可以从世界上的任何位置访问，因此其用户群可能位于非常远的地方，这种距离会由于较长的网络拓扑而导致性能下降。

&emsp;&emsp;对于这类情况，使用分布在不同地区的云、对数据进行分区或使用同步维护一致性的效果可能会更好一些。

## 数据设计实战