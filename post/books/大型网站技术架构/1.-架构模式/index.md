
> 概述

-  为了解决大型网站面临的高并发访问、海量数据处理、高可靠运行等一系列问题和挑战，大型互联网概述在实践中提出了许多解决方案，以实现网站高性能、高可用、易伸缩、可扩展、安全等各种技术架构目标。这些解决方案又被更多网站重复使用，从而主键形成大型网站架构模式。

## 1. 分层

- 分层是企业应用系统中最常见的一种架构模式，将系统在横向维度上切分成几部分，每个部分负责一部分相对比较单一的指责，然后通过上层对下层的依赖和调用组成一个完整的系统。

- 分层节后在计算机世界中无处不在，网络的7层通讯协议是一种分层结构；计算机硬件、操作系统、应用软件也可以看作是一种分层结构。在大型网站架构中也采用分层结构，将网站软件分为应用层、服务层、数据层。如表1.1所示

层级 | 作用
--- | ---
应用层|负责具体业务和视图展示，如网站首页搜索输入和结果展示
服务层|为应用提供服务支持，如用户管理服务，购物车服务等
数据层|提供数据存储访问服务，如数据库、缓存、文件、搜索引擎等


<center>表1.1-网站分层架构</center>

- 通过分层，可以更好地将一个庞大的软件系统切分成不同的部分，便于分工合作开发维护；各层之间具有一定的独立性，只需要维持调用接口不变，各层可以根据具体问题独立演化发展而不需要其它层必须作出相应调整。
- 但是分层架构也有一些挑战，就是`必须合理规划层次边界和接口`，在开发过程中，严格遵循分层架构的约束，禁止跨层调用及逆向调用。
- 在实践中，大的分层结构内部还可以继续分层，如应用层可以再细分为`视图层(美工负责)`和`业务逻辑层(工程师负责)`;服务层也可以细分为`数据接口层(适配各种输入和输出的数据格式)`和`逻辑处理层`。
- 分层架构是逻辑上的，在物理部署上，三层机构可以部署在同一个物理机器上，但是随着网站业务的发展，必然需要对已经分层的模块`分离部署`，即三层结构分别部署在不同的服务器上，使网站拥有更多的计算资源以应对越来越多的用户访问。
- 所以虽然分层架构模式最初目的是规划软件清晰的逻辑结构便于开发维护，但在网站的发展过程中，分层结构对网站支持高并发向分布式方向发展至关重要。因此`在网站规模还很小的时候就应该采用分层架构`，这样将来网站做大时才能更好的应对。

## 2. 分割
- 如果说分层是将软件在横向方面进行切分，那么分割就是在纵向方面对软件进行切分。
- 网站越大、功能越复杂，服务和数据处理的种类也越多，将`这些不同的功能和服务分割开来，包装成高内聚低耦合的模块单元`，一方面有助于软件的开发维护，另一方面，便于不同模块的分布式部署，提高网站的并发处理能力和功能扩展能力。
- 大型网站分割的粒度可能会很小，比如在应用层，将不同业务进行分割，例如将购物、论坛、搜索、广告分割成不同的应用，由独立的团队负责，部署在不同的服务器上；在同一个应用内部，如果规模庞大业务复杂，会继续进行分割，比如购物业务，可以进一步分割成机票酒店业务、3C业务，小商品业务等更细小的粒度。而即使在这个粒度上，还是可以继续分割成首页、搜索列表、商品详情等模块，这些模块不管在逻辑上还是物理部署上，都可以是独立的。同样在服务层也可以根据需要将服务分割成合适的模块。

## 3. 分布式
- 对于大型网站，分层和分割的一个主要目的是为了切分后的模块便于分布式部署，即`将不同模块部署在不同的服务器上，通过远程调用协议工作`。分布式意味着可以使用更多的计算机完成不同的功能，计算机越多，CPU、内存、存储资源也就越多，能够处理的并发访问和数据量就越大，进而能够为更多的用户提高服务。
- 但分布式在解决网站高并发问题的同时也带来了其它问题。首先，`分布式意味着服务调用必须通过网络`，这可能会对性能造成比较严重的影响;其次，`服务器越多，服务器宕机造成的概率就越大`，一台服务器宕机造成的服务不可用可能会导致很多应用不可访问，使网站可用性降低；另外，`数据在分布式的环境中保持数据一致性也非常困难`，分布式事物也难以保证，这对网站业务造成很大影响‘；`分布式还导致网站依赖错综复杂，开发管理维护困难`。**`因此分布式设计要根据具体情况量力而行，切莫为了分布式而分布式`**。
- 在网站应用中，常用的分布式方式方有一下几种。
    - **分布式应用和服务**：将分层和分割后的应用和服务模块分布式部署，除了可以改善网站性能和并发性，加快开发和发布速度，减少数据库链接资源小号外，还可以使不同应用复用共同的服务，便于业务功能扩展。
    - **分布式静态资源**：网站的静态资源如JS、CSS、LOGO图片等资源独立分布式部署，并采用独立的域名，即人们常说的动静分离。静态资源分布式部署可以减轻应用服务器的负载压力；通过使用独立域名加快浏览器并发加载的速度；由负责用户体验的团队进行开发和维护有利于网站分工合作，使不同技术工种术业有专攻。
    - **分布式数据和存储**：大型网站需要处理以P为单位的海量数据，单台计算机无法提供如此大的存储空间，这些数据需要分布式存储。除了对传统的关系数据库进行分布式部署外，为网站应用应运而生的各种NoSQL产品几乎都是分布式的。
    - **分布式计算**： 严格来说，应用、服务、实时数据处理都是计算，网站除了要处理这些在线业务，还有很大一部分用户没有直观感受的后台业务要处理，包括搜索引擎的索引构建、数据仓库的数据分析统计等。这些业务的计算规模非常庞大，目前网站普遍使用Hadoop及其MapReduce分布式计算框架进行此类处理计算，其特点是移动计算而不是移动数据，将计算程序分发到数据所在的位置以加速计算和分布式计算。此外，还有可以支持网站线上服务器配置实时更新的分布式配置；分布式环境下实现并发和协同的分布式锁；支持云存储的分布式文件系统等。

## 4. 集群
- 使用分布式虽然已经将分层和分割后的模块独立部署，但是对于用户访问集中的模块(比如门户首页)，还需要将独立部署的服务器集群化，即多台服务器部署相同应用构成一个集群，通过负载均衡设备共同对外提供服务。
- 因为服务器集群有更多服务提供更好的并发特性，当有更多用户访问的时候，只需要向集群中加入新的机器即可。同时因为一个应用由多台服务器提供，当某台服务器出现故障时，负载均衡设备或者系统的失效转移机制会将请求转发到集群中其它服务器上，使服务器故障不影响用户使用。所以在网站应用中，即使是访问量很小的分布式应用和服务，也至少要部署两台服务器构成一个小集群，目的就是提高系统的可用性。

## 5. 缓存
- `缓存就是将数据存放在距离计算最近的位置以加快处理速度`。缓存是改善软件性能的第一手段，现代CPU越来越快的一个重要因素就是使用了更多的缓存，在复杂的软件设计中，缓存几乎不出不在。在大型网站结构设计在很多方面都是用了缓存设计。
    - **CDN**：即内容分发网络，部署在距离中断用户最近的网络服务商，用户的网络请求总是先到达它的网络服务商那里，在这里缓存网站的一些静态资源，可以就近以最快速度返回给用户，如视频网站和门户网站将用户访问量大的热点内容缓存在CDN。
    - **反向代理**：反向代理属于网站前端架构的一部分。部署在网站的前端，当用户请求到达网站的数据中心时，最先访问到的就是反向代理服务器，这里缓存网站的静态资源。无需将请求继续转发给应用服务器就能返回给用户。
    - **本地缓存**：在应用服务器本地缓存热点数据，应用程序可以在本机内存中直接访问数据，而无需访问数据库。
    - **分布式缓存**：大型网站的数据量非常庞大，即使只缓存一小部分，需要的内存空间也不是单机能承受的，所以除了本地缓存，还需要分布式缓存，将数据缓存在一个专门的分布式缓存集群中，应用程序通过网络通讯访问缓存数据。使用缓存有两个前提条件，一是数据库访问热点不均衡，某些数据会被更频繁的访问，这些数据应该放在缓存中；二是数据在某个时间段内有效，不会很快过期，否则缓存的数据就会因失效而产生脏读。网站应用中，缓存除了可以加快数据访问速度，还可以减轻后端应用和数据存储的负载压力，这一点对网站数据库架构至关重要，网站数据库几乎都是按照有缓存的前提进行负载能力设计的。
    
## 6. 异步
- 计算机软件发展的一个重要目标和驱动力是降低软件耦合性。事物之间直接关系越少，就越少被彼此影响，越可以独立发展。大型网站架构中，系统解耦的手段除了前面提到的分层、分割、分布等，还有一个重要手段是异步，业务之间的消息传递不是同步调用，而是将一个业务操作分成多个阶段，每个阶段之间通过共享数据的方式异步执行进行协作。在单一服务器内部实现可通过多线程共享内存队列的方式实现异步，处在业务操作前面的线程将输出写入到队列，后面的线程从队列中读取数据进行处理；在分布式系统中，多个服务器集群通过分布式消息队列实现异步，分布式消息队列可以看作内存队列的分布式部署。异步架构是典型的生产者消费者模式，两者不存在直接调用，只要保持数据结构不变，彼此功能实现可以随意变化而不互相影响，这对网站扩展新功能非常便利。除此之外，使用异步消息队列还有如下特性。
    - **提高系统可用性**：消费者服务器发生故障，数据会在消息队列服务器中堆积，生产者服务器可以继续处理业务请求，系统整体表现无故障。消费者服务器恢复后，继续处理消息队列中的数据。
    - **加快网站相应速度**：处在业务处理前端的生产者服务器在处理完业务请求后，将数据写入消息队列，不需要等待消费者服务器处理就可以返回，响应延迟减少。
    - **消除并发访问高峰**：用户访问网站是随机的，存在访问高峰和低谷
